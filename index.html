<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Global BD Status | Created by JSKIM of LAM</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #1B2631; --accent: #27AE60; --current: #1A1A1B; --future: #F1C40F; --bg: #F4F6F7; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        #layout { display: flex; height: 100vh; width: 100vw; position: relative; }
        #map { flex-grow: 1; height: 100%; background: #DAEAF1; z-index: 1; }
        #sidebar { position: absolute; left: 0; top: 0; width: 320px; height: 100%; background: white; z-index: 2000; transition: transform 0.5s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #sidebar.hidden { transform: translateX(-100%); }
        #toggle-btn { position: absolute; right: -45px; top: 20px; width: 45px; height: 45px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 0 8px 8px 0; font-size: 18px; z-index: 2001; }
        .header { background: var(--primary); color: white; padding: 15px; cursor: pointer; }
        .global-cap { background: var(--accent); padding: 12px 15px; color: white; border-bottom: 2px solid rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        #list-container { flex-grow: 1; overflow-y: auto; background: var(--bg); }
        .group-header { padding: 10px 12px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.8rem; }
        .risk-header-current { background: var(--current); color: white; }
        .risk-header-future { background: var(--future); color: #333; }
        .region-header { background: #cbdceb; color: var(--primary); }
        .country-header { background: #eef2f5; color: #444; padding-left: 20px; font-size: 0.78rem; }
        .collapsible-content { display: none; }
        .open > .collapsible-content { display: block; }
        .plant-card { padding: 10px 12px 10px 30px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.72rem; background: white; position: relative; }
        .plant-card:hover { background: #f0f7ff; }
        .plant-card.current-risk { border-left: 5px solid var(--current); }
        .plant-card.future-risk { border-left: 5px solid var(--future); }
        .badge { font-size: 0.6rem; padding: 2px 4px; border-radius: 3px; color: white; background: var(--accent); float: right; margin-left: 5px; }
        .badge.black { background: var(--current); }
        .badge.yellow { background: var(--future); color: #333; }
        .loss-badge { background: #E74C3C; color: white; font-weight: bold; padding: 1px 5px; border-radius: 10px; font-size: 0.6rem; position: absolute; right: 10px; top: 8px; }
        .capa-info { color: #666; font-size: 0.62rem; margin-top: 2px; }
    </style>
</head>
<body>
<div id="layout">
    <div id="sidebar">
        <button id="toggle-btn" onclick="document.getElementById('sidebar').classList.toggle('hidden')">üìä</button>
        <div class="header" onclick="resetToGlobal()">
            <h1 style="margin:0; font-size:0.9rem;">Global BD Status</h1>
            <p style="margin:3px 0 0 0; font-size:0.6rem; opacity:0.8;">Created by JSKIM of LAM | 172 Lines Full Data</p>
        </div>
        <div class="global-cap" onclick="resetToGlobal()">
            <span style="font-size:0.62rem;">Global BD Total Capacity</span><br>
            <strong id="global-val" style="font-size:1rem;">0</strong> <small>K MT/Y</small>
        </div>
        <div id="list-container">
            <div id="current-risk-group" class="open">
                <div class="group-header risk-header-current" onclick="this.parentElement.classList.toggle('open')"><span>‚ö†Ô∏è CURRENT RISK</span><span id="current-total-header"></span></div>
                <div class="collapsible-content" id="current-risk-list"></div>
            </div>
            <div id="future-risk-group" class="open">
                <div class="group-header risk-header-future" onclick="this.parentElement.classList.toggle('open')"><span>üìÖ FUTURE MAINT</span><span id="future-total-header"></span></div>
                <div class="collapsible-content" id="future-risk-list"></div>
            </div>
            <div id="region-list"></div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const regionFlyTo = { "NEA": { c: [32, 122], z: 4 }, "SEA": { c: [5, 110], z: 5 }, "WE": { c: [50, 10], z: 5 }, "ME": { c: [28, 50], z: 5 }, "NA": { c: [38, -95], z: 4 }, "SA": { c: [-20, -55], z: 4 }, "CIS": { c: [55, 60], z: 4 }, "IND": { c: [20, 78], z: 5 }, "CE": { c: [48, 18], z: 6 }, "AFRICA": { c: [30, 31], z: 6 } };
    const regionColors = { "NEA": "#1597BB", "SEA": "#27AE60", "WE": "#8E44AD", "ME": "#F39C12", "NA": "#D35400", "SA": "#7F8C8D", "CIS": "#2980B9", "IND": "#16A085", "CE": "#E67E22", "AFRICA": "#34495E" };
    
    const map = L.map('map', {zoomControl: false}).setView([20, 10], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    let plantData = [];

    async function loadData() {
        try {
            const res = await fetch('bd_data.json');
            plantData = await res.json();
            initDashboard();
        } catch (e) { console.error("Data Load Error", e); }
    }

    function resetToGlobal() { map.flyTo([20, 10], 2, {duration: 2.0}); }

    function flyWithOffset(latlng, zoom) {
        const offset = document.getElementById('sidebar').classList.contains('hidden') ? 0 : 320;
        const target = map.project(latlng, zoom).subtract([offset / 2, 0]);
        map.flyTo(map.unproject(target, zoom), zoom, { duration: 2.0 });
    }

    function calculateLoss(p) { return p.days ? ((p.capacity / 365) * p.days).toFixed(1) : 0; }

    function initDashboard() {
        const globalTotalCapa = plantData.reduce((s, p) => s + p.capacity, 0);
        document.getElementById('global-val').innerText = globalTotalCapa.toLocaleString();
        
        const currentRisks = plantData.filter(p => p.status.includes('Current'));
        const futureRisks = plantData.filter(p => p.status.includes('Future'));
        const curLoss = currentRisks.reduce((s, p) => s + parseFloat(calculateLoss(p)), 0);
        const futLoss = futureRisks.reduce((s, p) => s + parseFloat(calculateLoss(p)), 0);
        
        document.getElementById('current-total-header').innerText = `${curLoss.toLocaleString()}K (${((curLoss/globalTotalCapa)*100).toFixed(1)}% Loss) ‚ñº`;
        document.getElementById('future-total-header').innerText = `${futLoss.toLocaleString()}K (${((futLoss/globalTotalCapa)*100).toFixed(1)}% Loss) ‚ñº`;

        const nested = {};
        plantData.forEach(p => {
            const isCurrent = p.status.includes('Current');
            const isFuture = p.status.includes('Future');
            const isRisk = isCurrent || isFuture;
            
            // Î¶¨Ïä§ÌÅ¨ ÏóÖÏ≤¥ ÌÖåÎëêÎ¶¨ Ï†úÍ±∞ ÏßÄÏπ® Î∞òÏòÅ (stroke: false)
            const m = L.circleMarker([p.lat, p.lng], {
                radius: Math.sqrt(p.capacity) * 0.65,
                fillColor: isCurrent ? '#1A1A1B' : (isFuture ? '#F1C40F' : regionColors[p.region]),
                stroke: !isRisk, 
                color: '#ffffff', weight: 1.5, fillOpacity: 0.9
            }).addTo(map);

            const loss = calculateLoss(p);
            const share = ((p.capacity / globalTotalCapa) * 100).toFixed(2);
            let pop = `<b>${p.company}</b><br>${p.location}<br>Capa: ${p.capacity}K (${share}%)<br>Status: ${p.status}`;
            if(p.days) pop += `<br><span style="color:red;font-weight:bold;">Loss: ${loss}K MT</span><br><small>Period: ${p.period} (${p.days} days)</small>`;
            m.bindPopup(pop); p._m = m;

            if (!nested[p.region]) nested[p.region] = { capa: 0, countries: {} };
            if (!nested[p.region].countries[p.country]) nested[p.region].countries[p.country] = { capa: 0, plants: [] };
            nested[p.region].capa += p.capacity;
            nested[p.region].countries[p.country].capa += p.capacity;
            nested[p.region].countries[p.country].plants.push(p);
        });

        const createCard = (p) => {
            const card = document.createElement('div');
            const isCur = p.status.includes('Current');
            card.className = `plant-card ${isCur?'current-risk':(p.status.includes('Future')?'future-risk':'')}`;
            const bCol = isCur ? 'black' : (p.status.includes('Future') ? 'yellow' : '');
            const lossBadge = p.days ? `<span class="loss-badge">${calculateLoss(p)}K Loss</span>` : '';
            card.innerHTML = `${lossBadge}<span class="badge ${bCol}">${p.status.split('(')[0]}</span><b>${p.company}</b><div class="capa-info">${p.capacity}K MT | ${p.days || 0} Days Ï†ïÏßÄ</div>`;
            card.onclick = (e) => { e.stopPropagation(); flyWithOffset([p.lat, p.lng], 9); setTimeout(() => p._m.openPopup(), 1800); };
            return card;
        };

        currentRisks.sort((a,b)=>b.capacity-a.capacity).forEach(p=>document.getElementById('current-risk-list').appendChild(createCard(p)));
        futureRisks.sort((a,b)=>b.capacity-a.capacity).forEach(p=>document.getElementById('future-risk-list').appendChild(createCard(p)));

        Object.entries(nested).sort((a,b)=>b[1].capa - a[1].capa).forEach(([rName, rData]) => {
            const rDiv = document.createElement('div');
            rDiv.innerHTML = `<div class="group-header region-header" onclick="flyWithOffset(regionFlyTo['${rName}'].c, regionFlyTo['${rName}'].z); this.parentElement.classList.toggle('open')"><span>${rName} (${((rData.capa/globalTotalCapa)*100).toFixed(1)}%)</span><span>‚ñº</span></div><div class="collapsible-content"></div>`;
            const countryList = rDiv.querySelector('.collapsible-content');
            Object.entries(rData.countries).sort((a,b)=>b[1].capa-a[1].capa).forEach(([cName, cData]) => {
                const cDiv = document.createElement('div');
                cDiv.innerHTML = `<div class="group-header country-header" onclick="this.parentElement.classList.toggle('open')"><span>${cName} (${((cData.capa/globalTotalCapa)*100).toFixed(1)}%)</span><span>‚ñº</span></div><div class="collapsible-content"></div>`;
                const pList = cDiv.querySelector('.collapsible-content');
                cData.plants.forEach(p => pList.appendChild(createCard(p)));
                countryList.appendChild(cDiv);
            });
            document.getElementById('region-list').appendChild(rDiv);
        });
    }
    loadData();
</script>
</body>
</html>
